@{
    ViewBag.Title = Model.Classroom.Name;
}

@model ClassroomDigiMasterVM

<h1>Klassrum</h1>
<label>@Model.Classroom.Name</label>
<div class="containerClassroom">
    @Html.Partial("_TeacherChatBox")
    @Html.Partial("_TeacherWaitingList")
    @Html.Partial("_TeacherInfoBox")
</div>
@section scriptsSection
    {
    <script src="~/js/signalr-client-1.0.0-alpha2-final.min.js"></script>
    <script>
        let digiUi = {
            sendInfoButton: $("#sendInfoButton"),
            teacherMessageBox: $("#teacherMessageBox"),
            infoBox: $("#infoBox"),
            removeFromWaitingList: $("#removeFromWaitingList"),
            teacherWaitingList: $("#teacherWaitingList"),
            chatBox: $("#chatBox")
        }

        let digiFunctions = {
            GetWaitingList: 'GetWaitingList',
            InfoSend: 'InfoSend',
            onInfoSend: 'onInfoSend',
            DeleteWaitingListItem: 'DeleteWaitingListItem',
            onDeleteWaitingListItem: 'onDeleteWaitingListItem',
            onUpdateWaitingListItem: 'onUpdateWaitingListItem',
            onChatSend: 'onChatSend'
        }

        $(document).ready(
            function () {
                let connection = new signalR.HubConnection('/digihub');
                connection.start().then(function () { connection.invoke(digiFunctions.GetWaitingList); });

                digiUi.sendInfoButton.click(
                    function () {
                        let message = {
                            "description": digiUi.teacherMessageBox.val(),
                            "command": "Info"
                        }
                        connection.invoke(digiFunctions.InfoSend, JSON.stringify(message));
                    });

                connection.on(digiFunctions.onInfoSend, data => {
                    digiUi.infoBox.append(data + "\n");
                    digiUi.teacherMessageBox.val("");
                    digiUi.infoBox.scrollTop(digiUi.infoBox[0].scrollHeight);
                });

                digiUi.removeFromWaitingList.click(() => {
                    let aliasToRemove = digiUi.teacherWaitingList.val(); //selecteditem;
                    let message = {
                        "alias": aliasToRemove,
                        "command": "Delete"
                    }
                    if (aliasToRemove != null) {
                        connection.invoke(digiFunctions.DeleteWaitingListItem, JSON.stringify(message));
                    }
                });

                connection.on(digiFunctions.onDeleteWaitingListItem, data => {
                    let json = json.parse(data);
                    for (var i = 0; i < json.length; i++) {
                        digiUi.teacherWaitingList.append('<option value="' + json[i] + '">' + 'test' + json[i] + '</option>');
                    }
                })

                connection.on(digiFunctions.onUpdateWaitingListItem, data => {
                    digiUi.teacherWaitingList.html("");
                    var jsonObj = JSON.parse(data);
                    for (var i = 0; i < jsonObj.length; i++) {
                        digiUi.teacherWaitingList.append("<option value='" + jsonObj[i].Alias + "'>" + jsonObj[i].Alias + " " + jsonObj[i].Location + " " + jsonObj[i].Description + "</option>");
                    }
                    alert('Antal elever som behöver hjälp: ' + jsonObj.length);
                });

                connection.on(digiFunctions.onChatSend, data => {
                    digiUi.chatBox.append(data + "\n");
                    digiUi.chatBox.scrollTop(digiUi.chatBox[0].scrollHeight);
                });
            }
        );
    </script>
}